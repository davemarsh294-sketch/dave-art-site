<script>
  async function initThankYou() {
    const params = new URLSearchParams(window.location.search);

    const stripeSessionId = params.get("session_id");
    const paypalOrderId = params.get("token");

    // Load the order saved before payment
    const order = JSON.parse(localStorage.getItem("pendingOrder") || "null");
    if (!order) return;

    let orderId = null;

    /* --------------------------------------------------
       STRIPE SUCCESS
    -------------------------------------------------- */
    if (stripeSessionId) {
      const response = await fetch(`/.netlify/functions/get-sessions?session_id=${stripeSessionId}`);
      const data = await response.json();

      if (data.session?.payment_status === "paid") {
        orderId = data.session.id; // Stripe Checkout Session ID

        await sendEmail(order, orderId);
        clearLocalData();
      }

      renderSummary(order);
      return;
    }

    /* --------------------------------------------------
       PAYPAL SUCCESS
    -------------------------------------------------- */
    if (paypalOrderId) {
      orderId = paypalOrderId;

      await sendEmail(order, orderId);
      clearLocalData();
      renderSummary(order);
      return;
    }
  }

  /* --------------------------------------------------
     SEND EMAIL VIA NETLIFY FUNCTION
  -------------------------------------------------- */
  async function sendEmail(order, orderId) {
    await fetch("/.netlify/functions/send-email", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        ...order,
        orderId
      })
    });
  }

  /* --------------------------------------------------
     CLEAR CART + ORDER
  -------------------------------------------------- */
  function clearLocalData() {
    localStorage.removeItem("dm_cart");
    localStorage.removeItem("pendingOrder");
    localStorage.removeItem("dm_delivery");
  }

  /* --------------------------------------------------
     RENDER SUMMARY
  -------------------------------------------------- */
  function renderSummary(order) {
    let subtotal = 0;
    let certificateFee = 0;

    order.items.forEach(item => {
      subtotal += item.price * item.quantity;
      if (item.certificate) certificateFee += 30;
    });

    const deliveryCost = order.delivery?.cost || 0;
    const total = subtotal + certificateFee + deliveryCost;

    document.getElementById("itemsTotal").textContent = "£" + subtotal.toFixed(2);
    document.getElementById("deliveryFee").textContent = "£" + deliveryCost.toFixed(2);
    document.getElementById("certificateFee").textContent = "£" + certificateFee.toFixed(2);
    document.getElementById("grandTotal").textContent = "£" + total.toFixed(2);
  }

  initThankYou();
</script>